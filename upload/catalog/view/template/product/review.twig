<form id="form-review">
  <div id="review">{{ list }}</div>
  <h2>{{ text_write }}</h2>
  {% if review_guest %}
    <div class="mb-3 required">
      <label for="input-author" class="form-label">{{ entry_author }}</label> 
      <input type="text" name="author" value="{{ customer }}" id="input-author" class="form-control"/>
      <div id="error-author" class="invalid-feedback"></div>
    </div>
    <div class="mb-3 required">
      <label for="input-text" class="form-label">{{ entry_review }}</label> 
      <textarea name="text" rows="5" id="input-text" class="form-control"></textarea>
      <div id="error-text" class="invalid-feedback"></div>
      <div class="invalid-feedback">{{ text_note }}</div>
    </div>
    <div class="row mb-3 required">
      <label class="form-label">{{ entry_rating }}</label>
      <div id="input-rating">
        {{ entry_bad }}&nbsp;
        <input type="radio" name="rating" value="1" class="form-check-input"/>
        &nbsp;
        <input type="radio" name="rating" value="2" class="form-check-input"/>
        &nbsp;
        <input type="radio" name="rating" value="3" class="form-check-input"/>
        &nbsp;
        <input type="radio" name="rating" value="4" class="form-check-input"/>
        &nbsp;
        <input type="radio" name="rating" value="5" class="form-check-input"/>
        &nbsp;{{ entry_good }}
      </div>
      <div id="error-rating" class="invalid-feedback"></div>
    </div>

    <!-- PHẦN UPLOAD ẢNH/VIDEO -->
    <div class="mb-3">
      <label for="input-media" class="form-label">
        <i class="fa fa-camera"></i> Thêm ảnh hoặc video (tùy chọn)
      </label>
      <input type="file" name="media[]" id="input-media" class="form-control" accept="image/*,video/*" multiple>
      <small class="form-text text-muted">
        <i class="fa fa-info-circle"></i> Ảnh tối đa 5MB, Video tối đa 50MB. Có thể chọn nhiều file (tối đa 10).
      </small>
      <div id="error-media" class="invalid-feedback"></div>
      
      <!-- Preview với nút xóa -->
      <div id="media-preview" class="mt-3 row g-2"></div>
    </div>

    {{ captcha }}
    <div class="text-end">
      <button type="submit" id="button-review" class="btn btn-primary">
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        <span class="button-text">{{ button_continue }}</span>
      </button>
    </div>
  {% else %}
    {{ text_login }}
  {% endif %}
</form>

<script type="text/javascript"><!--
// Mảng lưu trữ file đã chọn
var selectedFiles = [];

$('#review').on('click', '.pagination a', function(e) {
    e.preventDefault();
    $('#review').load(this.href);
});

// PREVIEW MEDIA KHI CHỌN FILE VỚI NÚT XÓA
document.getElementById('input-media').addEventListener('change', function(e) {
    const newFiles = Array.from(e.target.files);
    
    // Thêm file mới vào mảng
    newFiles.forEach(file => {
        if (selectedFiles.length < 10) {
            selectedFiles.push(file);
        }
    });
    
    if (selectedFiles.length > 10) {
        alert('⚠️ Chỉ được upload tối đa 10 file!');
        selectedFiles = selectedFiles.slice(0, 10);
    }
    
    renderMediaPreview();
});

// RENDER PREVIEW
function renderMediaPreview() {
    const preview = document.getElementById('media-preview');
    preview.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-3 position-relative';
        col.setAttribute('data-index', index);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            let mediaHTML = '';
            
            if (file.type.startsWith('image/')) {
                mediaHTML = `<img src="${e.target.result}" class="card-img-top" style="height: 120px; object-fit: cover;">`;
            } else if (file.type.startsWith('video/')) {
                mediaHTML = `<video src="${e.target.result}" class="card-img-top" style="height: 120px; object-fit: cover;" controls></video>`;
            }
            
            col.innerHTML = `
                <div class="card">
                    ${mediaHTML}
                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 remove-media" 
                            data-index="${index}" 
                            style="z-index: 10; opacity: 0.9; border-radius: 50%; width: 30px; height: 30px; padding: 0;">
                        <i class="fa fa-times"></i>
                    </button>
                    <div class="card-body p-2">
                        <small class="text-muted text-truncate d-block" title="${file.name}">${file.name}</small>
                        <small class="text-muted">${formatFileSize(file.size)}</small>
                    </div>
                </div>
            `;
        };
        reader.readAsDataURL(file);
        preview.appendChild(col);
    });
    
    // Update file count
    if (selectedFiles.length > 0) {
        document.querySelector('.form-text').innerHTML = `
            <i class="fa fa-info-circle"></i> Đã chọn <strong>${selectedFiles.length}</strong> file. 
            Ảnh tối đa 5MB, Video tối đa 50MB.
        `;
    } else {
        document.querySelector('.form-text').innerHTML = `
            <i class="fa fa-info-circle"></i> Ảnh tối đa 5MB, Video tối đa 50MB. Có thể chọn nhiều file (tối đa 10).
        `;
    }
}

// XÓA MEDIA
$(document).on('click', '.remove-media', function(e) {
    e.preventDefault();
    const index = parseInt($(this).data('index'));
    
    // Xóa file khỏi mảng
    selectedFiles.splice(index, 1);
    
    // Render lại preview
    renderMediaPreview();
    
    // Animation khi xóa
    $(this).closest('.col-6').fadeOut(300, function() {
        $(this).remove();
    });
});

// FORMAT FILE SIZE
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// SUBMIT FORM VỚI AJAX REALTIME
$('#form-review').on('submit', function(e) {
    e.preventDefault();

    // Tạo FormData từ form
    var formData = new FormData();
    
    // Thêm các field text
    formData.append('author', $('#input-author').val());
    formData.append('text', $('#input-text').val());
    formData.append('rating', $('input[name="rating"]:checked').val() || '');
    
    // Thêm các file đã chọn
    selectedFiles.forEach((file, index) => {
        formData.append('media[]', file);
    });
    
    var buttonText = $('#button-review .button-text');
    var spinner = $('#button-review .spinner-border');

    $.ajax({
        url: 'index.php?route=product/review.write&language={{ language }}&review_token={{ review_token }}&product_id={{ product_id }}',
        type: 'post',
        data: formData,
        dataType: 'json',
        cache: false,
        contentType: false,
        processData: false,
        beforeSend: function() {
            $('#button-review').prop('disabled', true);
            spinner.removeClass('d-none');
            buttonText.text('Đang gửi...');
        },
        complete: function() {
            $('#button-review').prop('disabled', false);
            spinner.addClass('d-none');
            buttonText.text('{{ button_continue }}');
        },
        success: function(json) {
            $('.alert-dismissible').remove();
            $('#form-review').find('.is-invalid').removeClass('is-invalid');
            $('#form-review').find('.invalid-feedback').removeClass('d-block');

            if (json['error']) {
                if (json['error']['warning']) {
                    $('#alert').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa-solid fa-circle-exclamation"></i> ' + json['error']['warning'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
                }

                for (key in json['error']) {
                    $('#input-' + key.replaceAll('_', '-')).addClass('is-invalid').find('.form-control, .form-select, .form-check-input, .form-check-label').addClass('is-invalid');
                    $('#error-' + key.replaceAll('_', '-')).html(json['error'][key]).addClass('d-block');
                }

                // Scroll đến lỗi đầu tiên
                $('html, body').animate({
                    scrollTop: $('.is-invalid:first').offset().top - 100
                }, 500);
            }

            if (json['success']) {
                // Hiển thị thông báo thành công
                $('#alert').prepend('<div class="alert alert-success alert-dismissible fade show"><i class="fa-solid fa-circle-check"></i> ' + json['success'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');

                // Reset form
                $('#input-author').val('{{ customer }}');
                $('#input-text').val('');
                $('#input-rating input[type=\'radio\']').prop('checked', false);
                $('#input-media').val('');
                
                // Reset mảng file và preview
                selectedFiles = [];
                $('#media-preview').html('');
                document.querySelector('.form-text').innerHTML = `
                    <i class="fa fa-info-circle"></i> Ảnh tối đa 5MB, Video tối đa 50MB. Có thể chọn nhiều file (tối đa 10).
                `;

                // RELOAD DANH SÁCH REVIEW VỚI ANIMATION
                $('#review').fadeTo(300, 0.3, function() {
                    $(this).load('index.php?route=product/review.list&language={{ language }}&product_id={{ product_id }}', function() {
                        $(this).fadeTo(300, 1);
                        
                        // Scroll đến review mới nhất
                        $('html, body').animate({
                            scrollTop: $('#review').offset().top - 100
                        }, 500);
                        
                        // Highlight review mới
                        $('#review table:first').css('background-color', '#d4edda')
                            .animate({ backgroundColor: '#ffffff' }, 2000);
                    });
                });

                // Scroll đến thông báo
                $('html, body').animate({
                    scrollTop: $('#alert').offset().top - 100
                }, 500);

                // Tự động ẩn thông báo sau 5 giây
                setTimeout(function() {
                    $('.alert-success').fadeOut(500, function() {
                        $(this).remove();
                    });
                }, 5000);
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            
            $('#alert').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa-solid fa-circle-exclamation"></i> Có lỗi xảy ra! Vui lòng thử lại. <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
        }
    });
});
//--></script>

<style>
/* Animation cho button */
#button-review {
    position: relative;
    transition: all 0.3s ease;
}

#button-review:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Style cho nút xóa */
.remove-media {
    transition: all 0.2s ease;
}

.remove-media:hover {
    transform: scale(1.1);
    opacity: 1 !important;
}

/* Animation cho preview */
#media-preview .card {
    animation: fadeInUp 0.3s ease;
    transition: all 0.3s ease;
}

#media-preview .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Loading animation */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}

/* Media preview card */
#media-preview .card {
    overflow: hidden;
    border-radius: 8px;
}

#media-preview .card-img-top {
    border-radius: 8px 8px 0 0;
}
</style>